version: "3"

volumes:
  db:
    driver: local
    driver_opts:
      type: none
      device: $PWD/volumes/database
      o: bind
  backend:
    driver: local
    driver_opts:
      type: none
      device: $PWD/backend
      o: bind
  frontend:
    driver: local
    driver_opts:
      type: none
      device: $PWD/frontend
      o: bind
  kanboard_data:
    driver: local
    driver_opts:
      type: none
      device: $PWD/volumes/kanboard/data
      o: bind
  kanboard_plugins:
    driver: local
    driver_opts:
      type: none
      device: $PWD/volumes/kanboard/plugins
      o: bind

services:
  traefik:
    image: traefik:v2.2
    command:
      - "--api=true"
      - "--api.insecure=true"
      - "--api.dashboard=true"
      - "--providers.docker"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  backend:
    image: leaguetables/backend:v1
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
    environment:
      CONTAINER_ROLE: app
    depends_on:
      - redis
      - db
    volumes:
      - backend:/usr/share/nginx/html
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.entrypoints=web"
      - "traefik.http.routers.backend.rule=PathPrefix(`/api`)"

  worker:
    image: leaguetables/backend:v1
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
    working_dir: /var/www/html
    environment:
      CONTAINER_ROLE: queue
    depends_on:
      - redis
      - db
    labels:
      - "traefik.enable=false"

  scheduler:
    image: leaguetables/backend:v1
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
    environment:
      CONTAINER_ROLE: scheduler
    depends_on:
      - redis
      - db
    labels:
      - "traefik.enable=false"

  db:
    image: linuxserver/mariadb
    environment:
      - PUID=1000
      - PGID=1000
      - MYSQL_ROOT_PASSWORD=helloworld
      - TZ=Europe/London
      - MYSQL_DATABASE=leaguetables
      - MYSQL_USER=leaguetables
      - MYSQL_PASSWORD=helloworld
    volumes:
      - db:/config
    ports:
      - 3306:3306
    restart: unless-stopped
    labels:
      - "traefik.enable=false"

  redis:
    image: redis
    expose:
      - 6379
    labels:
      - "traefik.enable=false"

  frontend:
    image: leaguetables/frontend:v1
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
    volumes:
      - frontend:/app
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"

###
### Development containers
###
  phpmyadmin:
    image: phpmyadmin
    depends_on:
      - db
    environment:
      - PMA_ARBITRARY=1
      - PMA_USER=root
      - PMA_PASSWORD=helloworld
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.phpmyadmin.entrypoints=web"
      - "traefik.http.routers.phpmyadmin.rule=Host(`phpmyadmin.local`)"

  kanboard:
    image: kanboard/kanboard:latest
    volumes:
      - kanboard_data:/var/www/app/data
      - kanboard_plugins:/var/www/app/plugins
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.kanboard.entrypoints=web"
      - "traefik.http.routers.kanboard.rule=Host(`kanboard.local`)"